#!/bin/sh
# initramfs init â€” systemd-safe, getty-safe, minimal

set -eux

echo ">>> INITRAMFS: starting"

# --------------------------------------------------
# 1. Mount kernel virtual filesystems
# --------------------------------------------------
mount -t proc     proc     /proc
mount -t sysfs   sysfs    /sys
mount -t devtmpfs devtmpfs /dev

mkdir -p /dev/pts
mount -t devpts devpts /dev/pts


# Required for systemd + getty
mkdir -p /run
mount -t tmpfs tmpfs /run

# --------------------------------------------------
# 2. Determine root device
# --------------------------------------------------
ROOTDEV=""

for arg in $(cat /proc/cmdline); do
    case "$arg" in
        root=*)
            ROOTDEV="${arg#root=}"
            ;;
    esac
done

[ -z "$ROOTDEV" ] && ROOTDEV="/dev/vda"

echo ">>> Using root device: $ROOTDEV"

# --------------------------------------------------
# 3. Wait for root block device (bounded)
# --------------------------------------------------
i=0
while [ ! -b "$ROOTDEV" ]; do
    i=$((i+1))
    [ "$i" -gt 50 ] && break
    sleep 0.1
done

[ -b "$ROOTDEV" ] || exec sh

# --------------------------------------------------
# 4. Mount real root
# --------------------------------------------------
mkdir -p /mnt
mount -t ext4 "$ROOTDEV" /mnt

# --------------------------------------------------
# 5. Prepare target root layout
# --------------------------------------------------
mkdir -p /mnt/{proc,sys,dev,run}

# Move mounts
mount --move /proc /mnt/proc
mount --move /sys  /mnt/sys
mount --move /dev  /mnt/dev
mount --move /run  /mnt/run

# --------------------------------------------------
# 6. Absolute minimum runtime state for getty/login
# --------------------------------------------------
# BusyBox getty REQUIREMENTS
touch /mnt/run/utmp
chmod 664 /mnt/run/utmp
chown 0:0 /mnt/run/utmp

# --------------------------------------------------
# 7. Switch root
# --------------------------------------------------
echo ">>> Switching to real root"
exec switch_root /mnt /sbin/init

# --------------------------------------------------
# Should never reach here
# --------------------------------------------------
exec sh
